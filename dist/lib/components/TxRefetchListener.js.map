{"version":3,"file":"TxRefetchListener.js","sources":["../../../lib/components/TxRefetchListener.jsx"],"sourcesContent":["import { useEffect, useState } from 'react'\nimport { useAtom } from 'jotai'\nimport { transactionsAtom } from '@pooltogether/hooks'\n\nconst debug = require('debug')('pool-app:TxRefetchListener')\n\nexport function TxRefetchListener(props) {\n  const [transactions] = useAtom(transactionsAtom)\n\n  const [storedPendingTransactions, setStoredPendingTransactions] = useState([])\n\n  const pendingTransactions = transactions.filter((t) => !t.completed && !t.cancelled)\n\n  useEffect(() => {\n    if (pendingTransactions.length !== storedPendingTransactions.length) {\n      setStoredPendingTransactions(pendingTransactions)\n    }\n\n    checkStoredPending(transactions, storedPendingTransactions)\n  }, [pendingTransactions])\n\n  return null\n}\n\nconst runRefetch = (tx) => {\n  // we don't know when the Graph will have processed the new block data or when it has\n  // so simply query a few times for the updated data\n\n  if (tx?.refetch) {\n    tx.refetch()\n    setTimeout(() => {\n      tx.refetch()\n      debug('refetch!')\n    }, 2000)\n\n    setTimeout(() => {\n      tx.refetch()\n      debug('refetch!')\n    }, 8000)\n  }\n}\n\nconst checkStoredPending = (transactions, storedPendingTransactions) => {\n  storedPendingTransactions.forEach((tx) => {\n    const storedTxId = tx.id\n    const currentTxState = transactions.find((_tx) => _tx.id === storedTxId)\n\n    const completed = currentTxState?.completed\n    const sent = currentTxState?.sent\n    const error = currentTxState.error\n    const cancelled = currentTxState.cancelled\n\n    if (!cancelled && !completed && sent) {\n      tx?.onSent?.()\n    } else if (completed && !error && !cancelled) {\n      tx?.onSuccess?.()\n      runRefetch(tx)\n    } else if (currentTxState && completed && error && !cancelled) {\n      tx?.onError?.()\n    } else if (currentTxState?.cancelled) {\n      tx?.onCancelled?.()\n    }\n  })\n}\n"],"names":["debug","require","TxRefetchListener","props","useAtom","transactionsAtom","transactions","useState","storedPendingTransactions","setStoredPendingTransactions","pendingTransactions","filter","t","completed","cancelled","useEffect","length","checkStoredPending","runRefetch","tx","refetch","setTimeout","forEach","storedTxId","id","currentTxState","find","_tx","sent","error","onSent","onSuccess","onError","onCancelled"],"mappings":"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"}